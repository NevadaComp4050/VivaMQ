# Batch API Documentation
## Setup up environment and Install Dependencies:

`npm install openai dotenv fs path`
1) Install the client library for access to OpenAI's API.
2) Load environment variables from a .env file into process.env to manage sensitive information like API keys.
3) Install Node.js built-in module for file system operations.
4) Install Node.js built-in module for handling file paths.


## Setup .jsonl File:
Batches start with a .jsonl file where each line contains the details of an individual request to the API. Each request must include a unique `custom_id`, which will be used to reference the results after completion.

An example `.json` file:
```javascript
{"custom_id": "example.pdf", "method": "POST", "url": "/v1/chat/completions", "body": {"model": "gpt-4o-2024-08-06", "messages": [{"role": "user", "content": "Return five questions to assess understanding of the following text:\n\nThis is the content of example.pdf."}],"max_tokens": 1000}}
{"custom_id": "testpdf.pdf", "method": "POST", "url": "/v1/chat/completions", "body": {"model": "gpt-4o-2024-08-06", "messages": [{"role": "user", "content": "Return five questions to assess understanding of the following text:\n\nThis is the content of example.pdf."}],"max_tokens": 1000}}
```

## Code explanation:

**Import necessary modules and load the environment variable from a '.env' file:**
```javascript
import fs from 'fs';
import { OpenAI } from 'openai';
import * as dotenv from 'dotenv';
import path from 'path';
dotenv.config();
```

---

**Initialize the OpenAI client using the API Key:**
```javascript
const client = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});
```
- Replace `OPENAI_API_KEY` with your own API key
- This creates an instance of the OpenAI client using the API key. 

---

**Type Definition**
```javascript
type OpenAIEndpoint = "/v1/chat/completions";
type CompletionWindow = "24h" ;
```
- `/v1/chat/completions`: API endpoint for processing batch job.
- `24h`: Maximum time frame for completing the batch job, 24 hours.

---

**Uploading Batch Input File**
```javascript
const fileStream = fs.createReadStream(inputFilePath);
const uploadedFile = await client.files.create({
   purpose: 'batch',
   file: fileStream,
 });

console.log(`Uploaded input file: ${uploadedFile.id}`);
```
- Create a readable stream from the input file.
- Call the OpenAI API to upload the input file.
  - `batch` indicates the purpose of uploading the file.
  - Passes the file stream to the API for uploading.
- Logs the file ID.

---

**Creating the Batch Job**
```javascript
let batchJob = await client.batches.create({
  input_file_id: uploadedFile.id,
  endpoint: endpoint,
  completion_window: completionWindow,
});

console.log(`Batch job created with ID: ${batchJob.id}`);
```
- Create a batch job on OpenAI's server with the uploaded file.
- Passes the Id of the uploaded file as a reference for the batch job.
- API endpoint for processing batch job, in this scenario: `/v1/chat/completions`.
- Maximum time frame for completing the batch job, in this scenario: `24h`.
- Logs the batch job Id.

---

**Monitor the Batch Job Status**
```javascript
let jobStatus = batchJob.status;
while (jobStatus !== 'completed' && jobStatus !== 'failed' && jobStatus !== 'cancelled') {
   batchJob = await client.batches.retrieve(batchJob.id);
   jobStatus = batchJob.status;
   console.log(jobStatus);
}
```
- Initialize a variable, `jobStatus `, to track the batch job status.
- Check the batch job's status in a loop until it is either 'completed', 'failed', or 'cancelled'.
  - Obtain the latest status of the batch job.
  - Logs the current job status.


--- 
  
**Retrieving the Result**
```javascript
if (jobStatus === 'completed') {
    const resultFileId = batchJob.output_file_id;

    if (resultFileId) {
    // Retrieve file content using OpenAI's `files.content` method
    const fileResponse = await client.files.content(resultFileId);
    const fileContents = await fileResponse.text(); // Get the content as text

    const resultFileName = 'batch_job_results.jsonl';

    // Save results to a file
    fs.writeFileSync(resultFileName, fileContents);

    console.log(`Results saved to ${resultFileName}`);

    return resultFileName;
}
```
- Check if the batch job completed successfully.
  - Obtain the output file Id generated by the batch job.
  - Checks if the output file ID is valid.
    - Obtain the content of the output file from the OpenAI API.
    - Convert the file into text.
    - Define a name for the output file.
    - Saves the output to a file named `batch_job_results.jsonl`.
    - Logs that the output was saved successfully. 


---
    
**Error Handling**
```javascript
else {
        console.error('Batch job completed, but no result file ID was returned.');
        return null;
      }
```
- Give an error if the batch job was completed but no output file ID was obtained.

```javascript
else {
      console.log(`Batch job failed with status: ${jobStatus}`);
      return null;
    }
```
- Give an error if the batch job failed.
```javascript
catch (error) {
    console.error('Error during batch processing:', error);
    return null;
  }
```
- Catch any errors that occured during the `try` block.
- Log the error.
- Return null to show that batch failed.

---

**Main Execution**
```javascript
(async () => {
  const inputFilePath = path.join('./input.jsonl');  // .jsonl file path
  const endpoint: OpenAIEndpoint = '/v1/chat/completions'; 
  const completionWindow: CompletionWindow = '24h';

  const resultFileName = await processBatch(inputFilePath, endpoint, completionWindow);

  // Print the results
  if (resultFileName) {
    console.log(`Batch processing completed. Results saved in ${resultFileName}`);
  }
 })();
```
- Specify the file path for the `input.jsonl` file.
- Define endpoint and completion window.
- Call `processBatc` to execute the batch job.
- If the batch process was successful, log the result file name.


## Running the program.

Setup a `.env` environment file to store the API Key. Replace `OPENAI_API_KEY` with an actual API Key:
`OPENAI_API_KEY =  "Your OpenAI API Key"`

Execute the command:
`npx ts-node batchJob.ts`